---
/**
 * COMPONENTE: Projects
 * ====================
 *
 * Sección principal de proyectos del portfolio con filtrado por tecnología.
 * Es la sección más compleja del template.
 *
 * PROPÓSITO:
 * - Mostrar todos tus proyectos en tarjetas (project cards)
 * - Filtrar proyectos por tecnología/skill
 * - Destacar proyectos importantes (featured/pinned)
 * - Mostrar galerías de imágenes de proyectos
 * - Mostrar explicaciones extendidas en modales
 * - Enlaces a demos, código fuente, sitios web, CSVs
 * - Tracking completo de interacciones con Google Analytics
 *
 * CARACTERÍSTICAS:
 * - Filtro de tecnologías con estilo terminal (ls -C)
 * - Proyectos destacados con badge "PINNED"
 * - Múltiples tipos de enlaces por proyecto
 * - Galerías de imágenes lightbox
 * - Modales de explicación con scroll
 * - Animaciones escalonadas al cargar
 * - Grid responsive adaptable
 * - Focus trap en modales (accesibilidad)
 *
 * ARQUITECTURA:
 * - HTML: Tarjetas de proyectos + filtros + modales
 * - CSS: Grid layout + responsive + animaciones
 * - JavaScript: Filtrado + modales + tracking + accesibilidad
 * - Datos: Vienen de projects-data.ts
 * - Internacionalización: Todo el contenido bilingüe
 *
 * INTEGRACIÓN:
 * - ImageGallery: Componente para galerías de screenshots
 * - getAllProjects(): Función que obtiene proyectos ordenados
 * - useI18n(): Traducciones según idioma
 *
 * PERSONALIZACIÓN:
 * - NO modificar este archivo
 * - Añadir/editar proyectos en: src/data/projects-data.ts
 * - Cambiar textos en: src/i18n/translations.ts
 */

// IMPORTACIONES
// -------------
// Componente de galería de imágenes lightbox
import ImageGallery from './ImageGallery.astro';

// Utilidad para obtener proyectos ordenados (featured primero)
import { getAllProjects } from '../lib/projects.js';

// Utilidad de internacionalización
import { useI18n } from '../lib/i18n.js';

// PROPS
// -----
interface Props {
  lang?: string;  // Idioma de la página ('es' o 'en')
}

// Obtiene props con valores por defecto
const { lang = 'es' } = Astro.props;

// TRADUCCIONES
// ------------
// Obtiene todas las traducciones según el idioma actual
// 't' contiene: projectsTitle, projectsDemo, projectsCode, etc.
const { t } = useI18n(lang);

// PROYECTOS
// ---------
// Obtiene todos los proyectos desde projects-data.ts
// Ya vienen ordenados: featured primero, luego el resto
const projects = getAllProjects();
---

<!--
  SECCIÓN PROJECTS
  ================

  ESTRUCTURA:
  - id="projects": Permite navegación directa con #projects
  - .border-top: Línea separadora superior (global.css)
  - .container: Clase para centrar contenido (global.css)

  COMPONENTES PRINCIPALES:
  1. Filtro de tecnologías (estilo terminal)
  2. Grid de tarjetas de proyectos
  3. Galerías de imágenes (ImageGallery)
  4. Modales de explicación
-->
<section id="projects" class="projects border-top">
  <!-- Contenedor centrado (global.css) -->
  <div class="container">
    <!-- Título de la sección -->
    <h2 class="mono">{t.projectsTitle}</h2>

    <!--
      FILTRO DE TECNOLOGÍAS
      =====================

      Sistema de filtrado con estilo de comando terminal.
      Simula el comando: $ ls -C technologies/

      FUNCIONAMIENTO:
      1. Botón toggle muestra/oculta la lista de tecnologías
      2. Lista se genera dinámicamente desde todos los proyectos
      3. Al hacer clic en una tecnología, filtra proyectos
      4. "all" muestra todos los proyectos

      ESTILO TERMINAL:
      - $ (prompt): Simula prompt de terminal
      - ls -C technologies/: Comando Unix para listar
      - _ (cursor): Cursor parpadeante animado
    -->
    <div class="filter-wrapper">
      <!--
        BOTÓN TOGGLE: Muestra/oculta filtros
        Al hacer clic, aparece el output estilo terminal
      -->
      <button class="filter-toggle mono" id="filter-toggle">
        <span class="prompt">$</span>
        <span class="command">ls -C technologies/</span>
        <span class="cursor">_</span>
      </button>

      <!--
        OUTPUT DEL FILTRO:
        Lista de tecnologías en formato columnar
        Inicialmente oculto (display: none)
        JavaScript lo muestra al hacer clic en toggle
      -->
      <div class="filter-output" id="filter-container" style="display: none;">
        <!-- Botón "all": Muestra todos los proyectos -->
        <button class="filter-btn active mono" data-filter="all">
          {lang === 'es' ? 'all' : 'all'}
        </button>

        <!--
          BOTONES DE TECNOLOGÍAS:
          Se generan dinámicamente desde los proyectos

          LÓGICA:
          1. projects.flatMap(p => p.tech): Obtiene todas las tecnologías
          2. new Set(): Elimina duplicados
          3. Array.from(): Convierte Set a Array
          4. sort(): Ordena alfabéticamente
          5. map(): Genera un botón por cada tecnología

          RESULTADO:
          Lista única y ordenada de todas las tecnologías usadas
        -->
        {Array.from(new Set(projects.flatMap(p => p.tech))).sort().map(tech => (
          <button class="filter-btn mono" data-filter={tech}>
            {tech}
          </button>
        ))}
      </div>
    </div>

    <!--
      GRID DE PROYECTOS
      =================

      Grid adaptable de tarjetas de proyectos.
      Se genera dinámicamente desde el array projects.

      CADA TARJETA INCLUYE:
      - Título del proyecto (bilingüe)
      - Descripción breve (soporta HTML)
      - Tech stack (etiquetas de tecnologías)
      - Enlaces condicionales según disponibilidad:
        • [demo]: Si project.demo !== null
        • [code]: Si project.link !== null
        • [web]: Si project.web !== null
        • [images]: Si project.images !== null
        • [explicación]: Si project.explanation !== undefined
        • [csv]: Si project.csv !== null

      CARACTERÍSTICAS:
      - Badge "PINNED" si project.featured === true
      - Animación escalonada (cada tarjeta +0.1s delay)
      - data-tech: Para filtrado por tecnología
      - data-event: Para tracking de Google Analytics
      - class "featured": Estilo destacado para proyectos importantes

      LAYOUT:
      - Grid adaptable: auto-fit con mínimo 300px
      - En mobile: 1 columna
      - En tablet: 2 columnas
      - En desktop: 3+ columnas (según ancho)

      ACCESIBILIDAD:
      - <article>: Elemento semántico para cada proyecto
      - target="_blank": Links externos abren en nueva pestaña
      - rel="noopener": Seguridad para links externos
      - fade-in: Animación de aparición (global.css)
    -->
    <div class="projects-grid">
      {projects.map((project, index) => (
        <article
          class={`project-card ${project.featured ? 'featured' : ''} fade-in`}
          style={`animation-delay: ${index * 0.1}s`}
          data-tech={project.tech.join(',')}
        >
          {/* Badge PINNED para proyectos destacados */}
          {project.featured && (
            <span class="featured-badge mono">{t.projectsFeatured}</span>
          )}

          {/* Título del proyecto (bilingüe) */}
          <h3>{project.title[lang]}</h3>

          {/* Descripción (soporta HTML con set:html) */}
          <p set:html={project.description[lang]}></p>

          {/* Tech Stack: Etiquetas de tecnologías usadas */}
          <div class="tech-stack">
            {project.tech.map(tech => (
              <span class="tech-tag">{tech}</span>
            ))}
          </div>

          {/* Enlaces del proyecto (solo se muestran si existen) */}
          <div class="project-links">
            {/* DEMO: Link a demo en vivo */}
            {project.demo && (
              <a
                href={project.demo}
                target="_blank"
                rel="noopener"
                data-event="click_demo"
                data-project={project.title[lang]}
              >
                <span class="mono">{t.projectsDemo}</span>
              </a>
            )}

            {/* CODE: Link a repositorio GitHub */}
            {project.link && (
              <a
                href={project.link}
                target="_blank"
                rel="noopener"
                data-event="click_code"
                data-project={project.title[lang]}
              >
                <span class="mono">{t.projectsCode}</span>
              </a>
            )}

            {/* WEB: Link a sitio web oficial */}
            {project.web && (
              <a
                href={project.web}
                target="_blank"
                rel="noopener"
                data-event="click_web"
                data-project={project.title[lang]}
              >
                <span class="mono">{t.projectsWeb}</span>
              </a>
            )}

            {/* IMAGES: Botón para abrir galería de screenshots */}
            {project.images && (
              <button
                class="btn-images mono"
                data-gallery={`gallery-${project.title[lang].toLowerCase().replace(/\s+/g, '-')}`}
                data-event="view_images"
                data-project={project.title[lang]}
              >
                {t.projectsImages}
              </button>
            )}

            {/* EXPLANATION: Botón para abrir modal de explicación */}
            {project.explanation && (
              <button
                class="btn-explanation mono"
                data-explanation={`explanation-${project.title[lang].toLowerCase().replace(/\s+/g, '-')}`}
                data-event="view_explanation"
                data-project={project.title[lang]}
              >
                {t.projectsExplanation}
              </button>
            )}

            {/* CSV: Link para descargar archivo CSV */}
            {project.csv && (
              <a
                href={project.csv}
                target="_blank"
                rel="noopener"
                data-event="download_csv"
                data-project={project.title[lang]}
              >
                <span class="mono">{t.projectsCsv}</span>
              </a>
            )}
          </div>
        </article>
      ))}
    </div>
  </div>

  <!--
    GALERÍAS DE IMÁGENES
    ====================

    Se generan componentes ImageGallery para cada proyecto que tenga imágenes.
    Las galerías son modales lightbox con navegación entre imágenes.
    JavaScript las conecta con los botones [images] de arriba.
  -->
  {projects.map(project =>
    project.images && (
      <ImageGallery images={project.images} projectTitle={project.title[lang]} />
    )
  )}

  <!--
    MODALES DE EXPLICACIÓN
    ======================

    Modales overlay para mostrar explicaciones extendidas de proyectos.
    Se generan solo para proyectos que tienen el campo explanation definido.

    CARACTERÍSTICAS:
    - Overlay oscuro (rgba(0,0,0,0.95))
    - Modal centrado con scroll
    - Botón X para cerrar
    - Cierre con Escape o click en overlay
    - Focus trap para accesibilidad
    - Restaura focus al botón que lo abrió

    ATRIBUTOS ARIA:
    - role="dialog": Indica que es un diálogo modal
    - aria-modal="true": Indica modalidad (bloquea interacción con fondo)
    - aria-labelledby: Conecta con el título del modal (accesibilidad)
    - aria-label: Etiqueta para el botón de cerrar
  -->
  {projects.map(project =>
    project.explanation && (
      <div
        class="explanation-modal"
        id={`explanation-${project.title[lang].toLowerCase().replace(/\s+/g, '-')}`}
        role="dialog"
        aria-modal="true"
        aria-labelledby={`modal-title-${project.title[lang].toLowerCase().replace(/\s+/g, '-')}`}
      >
        {/* Overlay oscuro de fondo */}
        <div class="modal-overlay" aria-hidden="true"></div>

        {/* Contenido del modal */}
        <div class="modal-content">
          {/* Botón cerrar (X) */}
          <button class="modal-close" aria-label={lang === 'es' ? 'Cerrar modal' : 'Close modal'}>×</button>

          {/* Cuerpo del modal con scroll */}
          <div class="modal-body">
            {/* Título del proyecto */}
            <h3 class="mono" id={`modal-title-${project.title[lang].toLowerCase().replace(/\s+/g, '-')}`}>
              {project.title[lang]}
            </h3>

            {/* Texto de explicación (soporta HTML) */}
            <div class="explanation-text" set:html={project.explanation ? project.explanation[lang] : ''}>
            </div>
          </div>
        </div>
      </div>
    )
  )}

  {projects.map(project =>
    project.images && (
      <ImageGallery images={project.images} projectTitle={project.title[lang]} />
    )
  )}
  
  {projects.map(project =>
    project.explanation && (
      <div
        class="explanation-modal"
        id={`explanation-${project.title[lang].toLowerCase().replace(/\s+/g, '-')}`}
        role="dialog"
        aria-modal="true"
        aria-labelledby={`modal-title-${project.title[lang].toLowerCase().replace(/\s+/g, '-')}`}
      >
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content">
          <button class="modal-close" aria-label={lang === 'es' ? 'Cerrar modal' : 'Close modal'}>×</button>
          <div class="modal-body">
            <h3 class="mono" id={`modal-title-${project.title[lang].toLowerCase().replace(/\s+/g, '-')}`}>{project.title[lang]}</h3>
            <div class="explanation-text" set:html={project.explanation ? project.explanation[lang] : ''}>
            </div>
          </div>
        </div>
      </div>
    )
  )}
</section>

<style>
  /**
   * ESTILOS: Projects Section
   * --------------------------
   *
   * CSS para la sección de proyectos, la más compleja del template.
   *
   * ESTRUCTURA:
   * 1. Filtro de tecnologías (toggle + output estilo terminal)
   * 2. Grid de tarjetas de proyectos (responsive)
   * 3. Modales de explicación (overlay + content)
   *
   * CARACTERÍSTICAS:
   * - Grid adaptable con auto-fit
   * - Múltiples breakpoints responsive (480px, 768px, 1024px, 1200px)
   * - Animaciones de cursor parpadeante y fade-in
   * - Proyectos destacados con estilo especial
   * - Modales overlay con scroll y focus trap
   * - Scrollbar oculta en modales
   * - Tema claro/oscuro adaptable
   *
   * VARIABLES CSS USADAS:
   * - var(--border): Color del borde
   * - var(--text): Color del texto
   * - var(--bg): Color de fondo
   * - var(--mono): Fuente monoespaciada
   *
   * RESPONSIVE BREAKPOINTS:
   * - 480px: Mobile pequeño
   * - 768px: Mobile/tablet
   * - 1024px: Tablet landscape
   * - 1200px: Desktop small
   */

  /* ============================================
     SECCIÓN PROJECTS: Contenedor principal
     ============================================ */
  .projects {
    padding: 6rem 0;  /* 96px arriba y abajo */
  }

  /* ============================================
     FILTRO: Wrapper del sistema de filtrado
     ============================================ */
  .filter-wrapper {
    margin-top: 2rem;     /* 32px arriba */
    margin-bottom: 2rem;  /* 32px abajo */
  }

  .filter-toggle {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    transition: all 0.3s;
    font-family: var(--mono);
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: fit-content;
    text-align: left;
  }

  .filter-toggle:hover {
    border-color: var(--text);
    transform: translateY(-2px);
  }

  .filter-toggle .prompt {
    color: var(--text);
    opacity: 0.7;
  }

  .filter-toggle .command {
    color: var(--text);
  }

  .filter-toggle .cursor {
    display: inline-block;
    animation: blink 1s infinite;
    opacity: 0.8;
  }

  @keyframes blink {
    0%, 49% { opacity: 1; }
    50%, 100% { opacity: 0; }
  }

  .filter-output {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.5rem 1rem;
    margin-top: 1rem;
    padding: 1.5rem;
    border: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.02);
  }

  @media (prefers-color-scheme: dark) {
    :root:not([data-theme="light"]) .filter-output {
      background: rgba(255, 255, 255, 0.02);
    }
  }

  [data-theme="dark"] .filter-output {
    background: rgba(255, 255, 255, 0.02);
  }

  .filter-btn {
    background: transparent;
    border: none;
    color: var(--text);
    padding: 0.4rem 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--mono);
    font-size: 0.85rem;
    text-align: left;
    width: 100%;
    opacity: 0.7;
    word-wrap: break-word;
    line-height: 1.3;
  }

  .filter-btn:hover {
    opacity: 1;
    background: rgba(255, 255, 255, 0.05);
  }

  .filter-btn.active {
    opacity: 1;
    color: var(--text);
    text-decoration: underline;
  }

  @media (max-width: 1200px) {
    .filter-output {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (max-width: 1024px) {
    .filter-output {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 768px) {
    .filter-output {
      grid-template-columns: repeat(2, 1fr);
      padding: 1rem;
      gap: 0.5rem 1rem;
    }
  }

  @media (max-width: 480px) {
    .filter-output {
      grid-template-columns: 1fr;
      gap: 0.5rem;
      padding: 1rem;
    }

    .filter-btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.5rem;
    }
  }

  .projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 3rem;
  }

  .project-card.hidden {
    display: none;
  }

  .project-card {
    padding: 2rem;
    border: 1px solid var(--border);
    transition: transform 0.3s, border-color 0.3s, background 0.3s;
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .project-card:hover {
    transform: translateY(-4px);
    border-color: var(--text);
  }

  .project-card.featured {
    border: 2px solid var(--text);
    background: linear-gradient(135deg, transparent 0%, rgba(0,0,0,0.02) 100%);
  }

  @media (prefers-color-scheme: dark) {
    :root:not([data-theme="light"]) .project-card.featured {
      background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.02) 100%);
    }
  }

  [data-theme="dark"] .project-card.featured {
    background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.02) 100%);
  }

  .featured-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 0.65rem;
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--text);
    background: var(--bg);
    letter-spacing: 0.1em;
  }

  .project-card h3 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .project-card.featured h3 {
    font-size: 1.75rem;
  }

  .project-card p {
    opacity: 0.8;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
    font-family: var(--mono);
    line-height: 1.7;
    flex-grow: 1;
  }

  .tech-stack {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    min-height: 3.5rem;
    align-content: flex-start;
  }

  .tech-tag {
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border: 1px solid var(--border);
    background: var(--bg);
  }

  .project-links {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: auto;
  }

  .project-links a,
  .btn-images {
    font-size: 0.9rem;
  }

  .btn-images {
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--text);
    color: var(--text);
    cursor: pointer;
    padding: 0;
    transition: opacity 0.2s;
    font-family: var(--mono);
  }

  .btn-images:hover {
    opacity: 0.6;
  }

  .btn-explanation {
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--text);
    color: var(--text);
    cursor: pointer;
    padding: 0;
    transition: opacity 0.2s;
    font-family: var(--mono);
  }

  .btn-explanation:hover {
    opacity: 0.6;
  }

  .explanation-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
  }

  .explanation-modal.active {
    display: block;
  }

  .explanation-modal .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
  }

  .explanation-modal .modal-content {
    position: relative;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    margin: 5% auto;
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 2rem;
    display: flex;
    flex-direction: column;
  }

  .explanation-modal .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: 2px solid var(--text);
    color: var(--text);
    font-size: 2rem;
    width: 3rem;
    height: 3rem;
    cursor: pointer;
    font-family: var(--mono);
    line-height: 1;
    transition: all 0.2s;
  }

  .explanation-modal .modal-close:hover {
    background: var(--text);
    color: var(--bg);
  }

  .explanation-modal .modal-body {
    margin-top: 1rem;
    overflow-y: auto;
    flex: 1;
    min-height: 0;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
  }

  .explanation-modal .modal-body::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }

  .explanation-modal h3 {
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
  }

  .explanation-text {
    font-family: var(--mono);
    font-size: 0.95rem;
    line-height: 1.7;
    opacity: 0.9;
    text-align: justify;
    padding-right: 0.5rem;
  }

  @media (max-width: 768px) {
    .explanation-modal .modal-content {
      width: 95%;
      max-height: 95vh;
      margin: 2.5% auto;
      padding: 1.5rem;
    }

    .explanation-modal .modal-close {
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.5rem;
    }

    .explanation-text {
      font-size: 0.9rem;
    }
  }

  @media (max-width: 768px) {
    .projects-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  /**
   * SCRIPT: Projects Interaction System
   * ====================================
   *
   * JavaScript client-side para toda la funcionalidad interactiva de proyectos.
   * Se ejecuta después de cargar la página (DOMContentLoaded).
   *
   * FUNCIONALIDADES:
   * 1. Sistema de filtrado por tecnología
   * 2. Toggle del panel de filtros (estilo terminal)
   * 3. Apertura de galerías de imágenes (ImageGallery)
   * 4. Modales de explicación (overlay + content)
   * 5. Tracking completo con Google Analytics
   * 6. Accesibilidad (focus trap, keyboard navigation)
   *
   * COMPONENTES:
   * - Filter Toggle: Botón que muestra/oculta panel de filtros
   * - Filter Buttons: Botones de tecnologías para filtrar proyectos
   * - Image Buttons: Botones [images] que abren galerías
   * - Explanation Buttons: Botones [explicación] que abren modales
   * - Explanation Modals: Modales overlay con scroll
   *
   * TRACKING DE EVENTOS:
   * Todos los elementos con data-event se trackean automáticamente:
   * - click_demo: Click en link de demo
   * - click_code: Click en link de código
   * - click_web: Click en link de web
   * - view_images: Click en botón de imágenes
   * - view_explanation: Click en botón de explicación
   * - download_csv: Click en link de CSV
   * - filter_technology: Filtrado por tecnología
   *
   * ACCESIBILIDAD:
   * - Focus trap: El foco se mantiene dentro de modales abiertos
   * - Keyboard navigation: Tab, Shift+Tab, Escape
   * - Focus restoration: Al cerrar modal, vuelve al botón que lo abrió
   * - ARIA attributes: role="dialog", aria-modal, aria-label
   *
   * INTEGRACIÓN CON IMAGEGALLERY:
   * Cada galería expone una función global window[`open_${galleryId}`]
   * Los botones [images] llaman a estas funciones para abrir galerías
   */

  // EVENT LISTENER: DOMContentLoaded
  // ---------------------------------
  // Espera a que todo el HTML esté cargado antes de ejecutar
  document.addEventListener('DOMContentLoaded', () => {
    // ===== REFERENCIAS AL DOM =====
    // Encuentra todos los elementos interactivos
    const imageButtons = document.querySelectorAll('.btn-images');          // Botones [images]
    const explanationButtons = document.querySelectorAll('.btn-explanation'); // Botones [explicación]
    const filterButtons = document.querySelectorAll('.filter-btn');          // Botones de tecnologías
    const projectCards = document.querySelectorAll('.project-card');         // Tarjetas de proyectos
    const filterToggle = document.getElementById('filter-toggle');           // Botón toggle filtros
    const filterContainer = document.getElementById('filter-container');     // Panel de filtros
    let lastFocusedElement = null;  // Guarda el elemento que abrió un modal

    // ===== TOGGLE DEL PANEL DE FILTROS =====
    // Muestra/oculta el panel de tecnologías estilo terminal
    filterToggle?.addEventListener('click', () => {
      const isVisible = filterContainer?.style.display !== 'none';

      if (filterContainer) {
        filterContainer.style.display = isVisible ? 'none' : 'grid';
        filterToggle.classList.toggle('active');
      }
    });

    // Google Analytics Event Tracking
    function trackEvent(eventName, eventParams) {
      if (typeof gtag !== 'undefined') {
        gtag('event', eventName, eventParams);
      }
    }

    // Track all clicks with data-event attribute
    document.addEventListener('click', (e) => {
      const element = e.target.closest('[data-event]');
      if (element) {
        const eventName = element.getAttribute('data-event');
        const projectName = element.getAttribute('data-project');

        trackEvent(eventName, {
          event_category: 'project_interaction',
          project_name: projectName,
          event_label: projectName
        });
      }
    });

    // Handle project filtering
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const filter = button.getAttribute('data-filter');

        // Track filter usage
        trackEvent('filter_technology', {
          event_category: 'project_filtering',
          technology: filter,
          event_label: filter
        });

        // Update active button
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        // Filter projects
        projectCards.forEach(card => {
          if (filter === 'all') {
            card.classList.remove('hidden');
          } else {
            const cardTechs = card.getAttribute('data-tech')?.split(',') || [];
            if (cardTechs.includes(filter)) {
              card.classList.remove('hidden');
            } else {
              card.classList.add('hidden');
            }
          }
        });
      });
    });

    // Handle image gallery buttons
    imageButtons.forEach(button => {
      button.addEventListener('click', () => {
        const galleryId = button.getAttribute('data-gallery');
        if (!galleryId) return;

        // Call the gallery's open function
        const openFunction = window[`open_${galleryId}`];
        if (openFunction) {
          openFunction(0);
        }
      });
    });

    // Handle explanation modal buttons
    explanationButtons.forEach(button => {
      button.addEventListener('click', () => {
        const explanationId = button.getAttribute('data-explanation');
        if (!explanationId) return;

        const modal = document.getElementById(explanationId);
        if (modal) {
          lastFocusedElement = document.activeElement;
          modal.classList.add('active');
          document.body.style.overflow = 'hidden';

          // Focus close button for accessibility
          const closeBtn = modal.querySelector('.modal-close');
          if (closeBtn) {
            setTimeout(() => closeBtn.focus(), 100);
          }

          // Trap focus within modal
          trapFocus(modal);
        }
      });
    });

    // Handle explanation modal close
    function closeModal(modal) {
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';

        // Restore focus to element that opened the modal
        if (lastFocusedElement) {
          lastFocusedElement.focus();
          lastFocusedElement = null;
        }
      }
    }

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-close') || e.target.classList.contains('modal-overlay')) {
        const modal = e.target.closest('.explanation-modal');
        closeModal(modal);
      }
    });

    // Handle escape key for explanation modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const activeModal = document.querySelector('.explanation-modal.active');
        closeModal(activeModal);
      }
    });

    // Focus trap utility
    function trapFocus(element) {
      const focusableElements = element.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];

      element.addEventListener('keydown', function(e) {
        if (e.key !== 'Tab') return;

        if (e.shiftKey) {
          if (document.activeElement === firstFocusable) {
            lastFocusable.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastFocusable) {
            firstFocusable.focus();
            e.preventDefault();
          }
        }
      });
    }
  });
</script>
